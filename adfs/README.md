# Extend Active Directory Federation Services (AD FS) to Azure

This reference architecture implements a secure hybrid network that extends your on-premises network to Azure and uses [Active Directory Federation Services (AD FS)](https://technet.microsoft.com/windowsserver/dd448613.aspx) to perform federated authentication and authorization for components running in Azure.

![](https://docs.microsoft.com/azure/architecture/reference-architectures/identity/images/adfs.png)

For guidance about best practices, see the article [Extend Active Directory Federation Services (AD FS) to Azure](https://docs.microsoft.com/azure/architecture/reference-architectures/identity/adfs) on the Azure Architecture Center.

## Deploy the solution

A solution is available on [GitHub][github] to deploy this reference architecture. You will need the latest version of the [Azure CLI][azure-cli] to run the Powershell script that deploys the solution. To deploy the reference architecture, follow these steps:

1. Download or clone the solution folder from [GitHub][github] to your local machine.

2. Open the Azure CLI and navigate to the local solution folder.

3. Run the following command:
   
    ```powershell
    .\Deploy-ReferenceArchitecture.ps1 <subscription id> <location> <mode>
    ```
   
    Replace `<subscription id>` with your Azure subscription ID.
   
    For `<location>`, specify an Azure region, such as `eastus` or `westus`.
   
    The `<mode>` parameter controls the granularity of the deployment, and can be one of the following values:
   
   * `Onpremise`: Deploys a simulated on-premises environment. You can use this deployment to test and experiment if you do not have an existing on-premises network, or if you want to test this reference architecture without changing the configuration of your existing on-premises network.
   * `Infrastructure`: deploys the VNet infrastructure and jump box.
   * `CreateVpn`: deploys an Azure virtual network gateway and connects it to the simulated on-premises network.
   * `AzureADDS`: deploys the VMs acting as Active Directory DS servers, deploys Active Directory to these VMs, and creates the domain in Azure.
   * `AdfsVm`: deploys the AD FS VMs and joins them to the domain in Azure.
   * `PublicDMZ`: deploys the public DMZ in Azure.
   * `ProxyVm`: deploys the AD FS proxy VMs and joins them to the domain in Azure.
   * `Prepare`: deploys all of the preceding deployments. **This is the recommended option if you are building an entirely new deployment and you don't have an existing on-premises infrastructure.** 
   * `Workload`: optionally deploys web, business, and data tier VMs and supporting network. Not included in the `Prepare` deployment mode.
   * `PrivateDMZ`: optionally deploys the private DMZ in Azure in front of the `Workload` VMs deployed above. Not included in the `Prepare` deployment mode.

4. Wait for the deployment to complete. If you used the `Prepare` option, the deployment takes several hours to complete, and finishes with the message `Preparation is completed. Please install certificate to all AD FS and proxy VMs.`

5. Restart the jump box (*ra-adfs-mgmt-vm1* in the *ra-adfs-security-rg* group) to allow its DNS settings to take effect.

6. [Obtain an SSL Certificate for AD FS][adfs_certificates] and install this certificate on the AD FS VMs. Note that you can connect to them through the jump box. The IP addresses are <em>10.0.5.4</em> and <em>10.0.5.5</em>. The default username is <em>contoso\testuser</em> with password <em>AweSome@PW</em>.
   
   > [!NOTE]
   > The comments in the Deploy-ReferenceArchitecture.ps1 script at this point provides detailed instructions for creating a self-signed test certificate and authority using the `makecert` command. However, perform these steps as a **test** only and do not use the certificates generated by makecert in a production environment.
   > 
   > 

7. Run the following PowerShell command to deploy the AD FS server farm:
   
    ```powershell
    .\Deploy-ReferenceArchitecture.ps1 <subscription id> <location> Adfs
    ``` 

8. On the jump box, browse to `https://adfs.contoso.com/adfs/ls/idpinitiatedsignon.htm` to test the AD FS installation (you may receive a certificate warning that you can ignore for this test). Verify that the Contoso Corporation sign-in page appears. Sign in as <em>contoso\testuser</em> with password <em>AweS0me@PW</em>.

9. Install the SSL certificate on the AD FS proxy VMs. The IP addresses are *10.0.6.4* and *10.0.6.5*.

10. Run the following PowerShell command to deploy the first AD FS proxy server:
   
    ```powershell
    .\Deploy-ReferenceArchitecture.ps1 <subscription id> <location> Proxy1
    ```

11. Follow the instructions displayed by the script to test the installation of the first proxy server.

12. Run the following PowerShell command to deploy the second proxy server:
    
    ```powershell
    .\Deploy-ReferenceArchitecture.ps1 <subscription id> <location> Proxy2
    ```

13. Follow the instructions displayed by the script to test the complete proxy configuration.

<!-- links -->
[adfs_certificates]: https://technet.microsoft.com/library/dn781428(v=ws.11).aspx
[github]: https://github.com/mspnp/reference-architectures/tree/master/identity/adfs
[azure-cli]: /azure/azure-resource-manager/xplat-cli-azure-resource-manager